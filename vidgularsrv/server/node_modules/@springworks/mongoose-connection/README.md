# @springworks/mongoose-connection


[![Build Status](https://travis-ci.org/Springworks/node-mongoose-connection.svg?branch=master)](https://travis-ci.org/Springworks/node-mongoose-connection)
[![Coverage Status](https://coveralls.io/repos/Springworks/node-mongoose-connection/badge.png?branch=master)](https://coveralls.io/r/Springworks/node-mongoose-connection?branch=master)

Module that creates and manages a named mongoose connection to a MongoDB database.

The module exports a single function used to create a named wrapper around a mongoose connection.

Example:

```js
var connection_name = 'my connection'; // Used to retrieve connection
var mongo_uri = 'mongodb://...';
var logger = null; // Optional Bunyan logger
var wrapped_connection = require('@springworks/mongoose-connection')(connection_name, mongo_uri, logger);

// The connection:
wrapped_connection.connection();

// Connect to the DB. The connect method can be called multiple times.
// Callbacks will be queued until the connection is established (or it failes).
wrapped_connection.connect(function(err) {
  if (!err) {
    // Connected
  }
});

// Disconnect from the DB. Like the connect method, disconnect can be called
// multiple times and will queue callbacks until disconnected.
wrapped_connection.disconnect(function(err) {
  if (!err) {
    // Disconnected
  }
});

// Ping the db server (using the db command "ping")
wrapped_connection.ping(function(err) {
  console.log('Ping %s', err ? 'failed' : 'succeeded');
});
```

## Mongoose
This module will export its own version of mongoose. Please use that export instead of having
mongoose as a dependency in the project using this module. The motivation behind this is that
we ran into errors when using different versions of mongoose in the project using this module.

```javascript
var mongoose = require('@springworks/mongoose-connection').mongoose;
```


## API

### `module.exports(connection_name, mongo_uri, logger)`

Create or retrieve a shared connection wrapper by name and uri.

Returns an object with the methods `connection`, `connect` and `disconnect`.


### `connection()`

Get the connection object used by mongoose.


### `connect(callback)`

Connect to the DB. The connect method can be called multiple times while connecting. Callbacks will be queued until the connection is established (or it failes).

The callback function will be invoked with a single `err` param.


### `disconnect(callback)`

Disconnect from the DB. Like the connect method, disconnect can be called multiple times and will queue callbacks until disconnected.

The callback function will be invoked with a single `err` param.


### `ping(callback)`

Ping db server using the ping command. The ping command is a no-op used to test whether a server is responding to commands. This command will return immediately even if the server is write-locked.

The callback function will be invoked with a single `err` param if ping fails.
